<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Don't Buy a Lemon! Pre Purchase Vehicle Inspection - Today & Weekends - Eek Mobile Mechanical</title>
  <meta name="description" content="Same-day & weekend vehicle inspections. 600+ workshop locations nationwide. Report delivered within 90 minutes. Don't buy a lemon! Book your inspection today." />
  <meta name="keywords" content="pre purchase inspection, same day inspection, weekend vehicle inspection, car inspection NZ, don't buy a lemon, urgent inspection" />

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://www.redditstatic.com https://googleads.g.doubleclick.net;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      connect-src 'self' https://www.google-analytics.com https://www.redditstatic.com https://pixel-config.reddit.com https://www.googletagmanager.com https://googleads.g.doubleclick.net https://www.google.com https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com;
      frame-src 'self' https://www.googletagmanager.com https://www.google.com;
    ">

  <!-- Reddit Pixel -->
  <script>
    !function(w,d){if(!w.rdt){var p=w.rdt=function(){p.sendEvent?p.sendEvent.apply(p,arguments):p.callQueue.push(arguments)};p.callQueue=[];var t=d.createElement("script");t.src="https://www.redditstatic.com/ads/pixel.js",t.async=!0;var s=d.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}}
    (window,document);
    rdt('init', 'a2_hf16791nsdhx');
    rdt('track', 'PageVisit');
  </script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17084465163"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'AW-17084465163');
    gtag('config', 'G-DQNKF1YLWR');
  </script>

  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <style>
    :root{
      --brand:#ff5500; --brand2:#ff7733; --ok:#28a745; --warn:#ff9500; --danger:#dc3545; --muted:#6c757d;
    }
    body{font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:#f5f5f5;margin:0;padding:0 0 80px 0;color:#333;text-align:center}
    header{background:#fff;padding:20px 20px 30px 20px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .business-name{font-size:2.2em;font-weight:700;color:var(--brand);margin:.3em 0;text-shadow:1px 1px 2px rgba(0,0,0,.08)}
    header img{max-width:250px;height:auto;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    h1{font-size:1.8em;margin:.5em 0 .2em}

    .breadcrumb{background:#e8f4f8;padding:10px 20px;margin:0;text-align:left;font-size:.9em}
    .breadcrumb a{color:var(--brand);text-decoration:none}
    .breadcrumb a:hover{text-decoration:underline}

    .booking-container{max-width:960px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);overflow:hidden}
    .booking-header{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:30px;text-align:center}
    .booking-header h2{margin:0 0 10px 0;font-size:2em}
    .booking-header p{margin:0;font-size:1.1em;opacity:.95}

    .availability-banner{background:#28a745;color:#fff;padding:20px;margin-bottom:0;text-align:center}
    .availability-banner h3{margin:0 0 10px 0;font-size:1.6em;font-weight:800}
    .availability-banner p{margin:5px 0;font-size:1.1em}
    .availability-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
    .availability-item{background:rgba(255,255,255,.2);padding:15px;border-radius:8px}
    .availability-number{font-size:2em;font-weight:900;display:block;margin-bottom:5px}

    .progress-bar{display:flex;justify-content:space-between;margin:20px 0;padding:0 10px;overflow-x:auto}
    .progress-step{flex:1;text-align:center;position:relative;min-width:60px}
    .progress-step::before{content:'';width:24px;height:24px;border-radius:50%;background:#ddd;display:block;margin:0 auto 6px}
    .progress-step.active::before{background:var(--brand)}
    .progress-step.completed::before{background:var(--ok)}
    .progress-step span{font-size:.85em;color:#666}
    .progress-step.active span{color:var(--brand);font-weight:700}

    .booking-steps{padding:30px}
    .step{display:none;text-align:left}
    .step.active{display:block}
    .step h3{color:var(--brand);margin-bottom:20px;font-size:1.4em}

    .service-selector{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin:30px 0}
    .service-option{background:#fff;border:3px solid #ddd;border-radius:16px;padding:25px;cursor:pointer;transition:all .3s ease;position:relative;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .service-option:hover{transform:translateY(-4px);border-color:var(--brand);box-shadow:0 8px 24px rgba(255,85,0,.2)}
    .service-option.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe8df);box-shadow:0 8px 24px rgba(255,85,0,.25)}
    .service-option.recommended{border-color:var(--ok);background:linear-gradient(135deg,#f0fff4,#e8ffed)}
    .service-option.recommended::before{content:'MOST POPULAR';position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--ok);color:#fff;padding:4px 16px;border-radius:20px;font-size:.75em;font-weight:700;letter-spacing:.5px}
    .service-option.recommended.selected{border-color:var(--ok);background:linear-gradient(135deg,#e1ffe6,#d4f8db)}
    .service-title{font-size:1.4em;font-weight:800;margin-bottom:8px;color:#333}
    .service-price{font-size:2em;font-weight:900;color:var(--brand);margin:15px 0}
    .service-option.recommended .service-price{color:var(--ok)}
    .service-description{color:#666;font-size:.95em;line-height:1.5;margin-bottom:20px}
    .service-features{list-style:none;padding:0;margin:20px 0}
    .service-features li{padding:8px 0;border-bottom:1px solid #eee;display:flex;align-items:flex-start;font-size:.9em}
    .service-features li:last-child{border-bottom:none}
    .service-features li::before{content:'‚úì';color:var(--ok);font-weight:700;margin-right:10px;font-size:1.2em;flex-shrink:0}
    .service-option.recommended .service-features li::before{color:var(--ok)}
    .service-savings{background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:12px;margin-top:15px;font-size:.9em;color:#856404;font-weight:600}

    .contact-info{margin:15px 0}
    .contact-info label{display:block;margin-bottom:8px;font-weight:700}
    .contact-info .input-wrapper{position:relative;margin-bottom:15px;}
    .contact-info input,.contact-info textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1em;box-sizing:border-box;transition:all .3s ease;}
    .contact-info input:focus,.contact-info textarea:focus{border-color:var(--brand);outline:none}
    .contact-info input.valid{border-color:#28a745;background:#f8fff9}
    .contact-info input.error{border-color:#dc3545;background:#fff5f5}
    .contact-info textarea{height:100px;resize:vertical;margin-bottom:15px;}
    .validation-check{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#28a745;font-weight:900;font-size:1.2em;pointer-events:none;}
    .error-message{color:#dc3545;font-size:.9em;margin:-10px 0 10px 0;display:none}
    .error-message.show{display:block}

    .info-box{background:#e8f4f8;border:2px solid #bee5eb;border-radius:12px;padding:20px;margin:20px 0;text-align:left}
    .info-box h4{margin:0 0 15px 0;color:#0c5460}
    .info-box p{margin:10px 0;line-height:1.5;color:#0c5460}

    .highlight-box{background:#fff3cd;border:2px solid #ffeaa7;border-radius:12px;padding:20px;margin:20px 0;text-align:left}
    .highlight-box h4{margin:0 0 10px 0;color:#856404}
    .highlight-box p{margin:8px 0;color:#856404;line-height:1.5}
    .highlight-box ul{margin:10px 0;padding-left:20px;color:#856404}
    .highlight-box li{margin:8px 0;line-height:1.5}

    .competitor-box{background:#f8f9fa;border:2px solid #dee2e6;border-radius:12px;padding:20px;margin:20px 0;text-align:left}
    .competitor-box h4{margin:0 0 15px 0;color:#495057}
    .competitor-box p{margin:8px 0;color:#6c757d;line-height:1.5}

    .day-selector{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:30px 0}
    .day-option{background:#fff;border:3px solid #ddd;border-radius:16px;padding:30px;cursor:pointer;transition:all .3s ease;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.08);position:relative}
    .day-option:hover{transform:translateY(-4px);border-color:var(--brand);box-shadow:0 8px 24px rgba(255,85,0,.2)}
    .day-option.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe8df);box-shadow:0 8px 24px rgba(255,85,0,.25)}
    .day-option.featured{border-color:#28a745;background:linear-gradient(135deg,#f0fff4,#e8ffed)}
    .day-option.featured::before{content:'AVAILABLE TODAY';position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:#28a745;color:#fff;padding:4px 16px;border-radius:20px;font-size:.75em;font-weight:700;letter-spacing:.5px;white-space:nowrap}
    .day-option.featured.selected{border-color:#28a745;background:linear-gradient(135deg,#e1ffe6,#d4f8db)}
    .day-title{font-size:1.8em;font-weight:800;margin-bottom:10px;color:#333}
    .day-subtitle{font-size:1.1em;color:#666;margin-bottom:15px}
    .day-description{font-size:.95em;color:#666;line-height:1.5}

    .vehicle-types{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:20px 0}
    .vehicle-type{position:relative;background:#fff;border:2px solid #ddd;border-radius:12px;padding:20px;text-align:left;cursor:pointer;transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .vehicle-type:hover{transform:translateY(-2px);border-color:var(--brand);box-shadow:0 8px 20px rgba(255,85,0,.15)}
    .vehicle-type.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe8df);box-shadow:0 8px 22px rgba(255,85,0,.18);border-width:3px}
    .vehicle-type.popular{border-color:var(--ok);background:linear-gradient(135deg,#f2fff5,#e9ffef)}
    .vehicle-type.popular.selected{border-color:var(--ok);background:linear-gradient(135deg,#eaffea,#dbf8e0);border-width:3px}
    .vehicle-type-title{font-size:1.15rem;font-weight:800;margin-bottom:6px}
    .vehicle-type-subtitle{color:#555;font-size:1rem;margin-bottom:6px}
    .vehicle-note{color:#666;font-size:.95rem;margin-top:6px}

    .reservation-summary{background:#e8f4f8;border-radius:8px;padding:20px;margin:20px 0}
    .reservation-summary h4{margin:0 0 15px 0}
    .summary-item{display:flex;justify-content:space-between;margin:8px 0;align-items:center;font-size:.95em}
    .summary-item strong{color:var(--brand)}

    .trust-badges{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin:20px 0;text-align:center}
    .trust-badge{padding:15px;background:#f8f9fa;border-radius:8px;border:2px solid #e9ecef;}
    .trust-badge-icon{font-size:2em;margin-bottom:8px;}
    .trust-badge-text{font-size:.9em;color:#495057;font-weight:600;}

    .button{background:var(--brand);color:#fff;padding:14px 28px;border:none;border-radius:8px;cursor:pointer;font-size:1.05em;text-decoration:none;display:inline-block;transition:all .2s;margin:10px 5px;font-weight:600;min-height:44px;min-width:44px;}
    .button:hover{background:#e04400;transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,85,0,.3)}
    .button.secondary{background:var(--muted)}
    .button.secondary:hover{background:#545b62}
    .button:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none}
    .button.processing{background:var(--muted);position:relative}
    .button.processing::after{content:'...';animation:dots 1.5s steps(3,end) infinite}
    @keyframes dots{0%,20%{content:'.'}40%{content:'..'}60%,100%{content:'...'}}

    .terms-section{background:#f8f9fa;border-radius:8px;padding:20px;margin:20px 0;text-align:left}
    .terms-checkbox{display:flex;align-items:flex-start;gap:10px;margin:15px 0}
    .terms-checkbox input{margin-top:4px;transform:scale(1.3);min-width:20px;min-height:20px;}
    .terms-text{font-size:.95em;line-height:1.5}
    .terms-text a{color:var(--brand);text-decoration:none}
    .terms-text a:hover{text-decoration:underline}

    .notification{position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#ff5500,#e04400);color:#fff;padding:15px 20px;border-radius:12px;box-shadow:0 8px 32px rgba(255,85,0,.4);z-index:1001;transform:translateX(400px);opacity:0;transition:all .4s ease;max-width:320px;border-left:4px solid rgba(255,255,255,.3)}
    .notification.show{transform:translateX(0);opacity:1}
    .notification.error{background:linear-gradient(135deg,#dc3545,#c82333);box-shadow:0 8px 32px rgba(220,53,69,.4)}
    .notification-content{display:flex;align-items:center;gap:12px}
    .notification-icon{font-size:1.5em;flex-shrink:0}
    .notification-text{flex:1;font-size:.95em;line-height:1.4}
    .notification-close{background:none;border:none;color:#fff;cursor:pointer;font-size:1.2em;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s ease;flex-shrink:0}
    .notification-close:hover{background:rgba(255,255,255,.2)}

    .exit-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;}
    .exit-popup.show{display:flex;}
    .exit-popup-content{background:#fff;border-radius:12px;padding:40px;max-width:500px;text-align:center;position:relative;animation:slideIn .4s ease;}
    @keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .exit-popup-close{position:absolute;top:15px;right:15px;background:none;border:none;font-size:28px;cursor:pointer;color:#999;transition:color .2s;width:40px;height:40px;display:flex;align-items:center;justify-content:center;}
    .exit-popup-close:hover{color:#333;}

    @media (max-width: 768px) {
      .booking-steps{padding:20px}
      .business-name{font-size:1.8em}
      .availability-grid{grid-template-columns:1fr}
      .service-selector{grid-template-columns:1fr}
      .day-selector{grid-template-columns:1fr}
      .vehicle-types{grid-template-columns:1fr}
      .trust-badges{grid-template-columns:1fr;gap:10px;}
      .progress-bar{padding:0 5px}
      .progress-step{min-width:50px}
      .progress-step span{font-size:.75em}
      .notification{top:10px;right:10px;left:10px;max-width:none;transform:translateY(-100px)}
      .notification.show{transform:translateY(0)}
      .exit-popup-content{padding:30px 20px;margin:0 10px;}
    }
  </style>
</head>
<body>
<header id="mainHeader">
  <img src="/lemon.png" alt="Don't buy a lemon! Eek Mobile Mechanical Pre Purchase Vehicle Inspection" />
  <div class="business-name">Eek Mobile Mechanical</div>
  <h1>Don't Buy a Lemon! Get a Pre Purchase Vehicle Inspection Today</h1>
  
  <div style="background:linear-gradient(135deg,var(--brand),var(--brand2));border-radius:12px;padding:25px;margin:20px auto;max-width:700px;box-shadow:0 4px 12px rgba(255,85,0,.2);">
    <p style="color:#fff;font-size:1.15em;margin:0 0 20px 0;font-weight:600;line-height:1.5;">The average hidden repair we find costs <strong>$3,200</strong>. Don't risk it. Here's what we uncover:</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:20px;text-align:center;">
      <div>
        <div style="font-size:2.5em;font-weight:900;color:#fff;line-height:1;">20%</div>
        <div style="color:rgba(255,255,255,.95);font-size:.95em;margin-top:8px;">of vehicles rejected</div>
      </div>
      <div>
        <div style="font-size:2.5em;font-weight:900;color:#fff;line-height:1;">40%</div>
        <div style="color:rgba(255,255,255,.95);font-size:.95em;margin-top:8px;">have unaddressed recalls</div>
      </div>
      <div>
        <div style="font-size:2.5em;font-weight:900;color:#fff;line-height:1;">25%</div>
        <div style="color:rgba(255,255,255,.95);font-size:.95em;margin-top:8px;">electrical problems</div>
      </div>
      <div>
        <div style="font-size:2.5em;font-weight:900;color:#fff;line-height:1;">$3,200</div>
        <div style="color:rgba(255,255,255,.95);font-size:.95em;margin-top:8px;">average savings</div>
      </div>
    </div>
  </div>
</header>

<div class="breadcrumb" id="mainBreadcrumb">
  <a href="/" class="tracking-link">Home</a> > Don't Buy a Lemon - Pre Purchase Inspection
</div>

<div class="availability-banner" id="mainBanner">
  <h3>Same-Day & Weekend Inspections Available</h3>
  <p>Don't wait days for other services - get your inspection done today</p>
  <div class="availability-grid">
    <div class="availability-item">
      <span class="availability-number">600+</span>
      Workshop locations nationwide
    </div>
    <div class="availability-item">
      <span class="availability-number">Today</span>
      Same-day service available
    </div>
    <div class="availability-item">
      <span class="availability-number">60-90min</span>
      Report delivery time
    </div>
  </div>
</div>

<div class="booking-container">
  <div class="booking-header">
    <h2>Book Your Inspection</h2>
    <p>Same-day & weekend service ‚Ä¢ 7 simple steps ‚Ä¢ Secure payment</p>
  </div>

  <div class="progress-bar">
    <div class="progress-step active" id="step1-progress"><span>Service</span></div>
    <div class="progress-step" id="step2-progress"><span>Your Info</span></div>
    <div class="progress-step" id="step3-progress"><span>Vehicle</span></div>
    <div class="progress-step" id="step4-progress"><span>Seller</span></div>
    <div class="progress-step" id="step5-progress"><span>When</span></div>
    <div class="progress-step" id="step6-progress"><span>Type</span></div>
    <div class="progress-step" id="step7-progress"><span>Confirm</span></div>
  </div>

  <div class="booking-steps">
    <!-- Step 1: Service Selection -->
    <div class="step active" id="step1">
      <div style="background:#e8f4f8;border-radius:8px;padding:20px;margin-bottom:25px;text-align:center;">
        <h2 style="margin:0 0 10px 0;color:#0c5460;font-size:1.6em;">1 in 5 Vehicles We Inspect Get Rejected</h2>
        <p style="margin:0;color:#0c5460;font-size:1.05em;">Don't lose $3,200 on hidden repairs. Choose Comprehensive for detailed analysis, professional valuation, and credit protection if it's a lemon.</p>
      </div>

      <div class="service-selector">
        <div class="service-option" onclick="selectService('basic', 299, this)">
          <div class="service-title">Basic Mechanical</div>
          <div class="service-price">$299</div>
          <div class="service-description">Quick mechanical assessment</div>
          <ul class="service-features">
            <li>44-point inspection</li>
            <li>Pass/fail assessment</li>
            <li>Report delivered immediately</li>
          </ul>
        </div>

        <div class="service-option recommended selected" onclick="selectService('comprehensive', 599, this)">
          <div class="service-title">Comprehensive Report</div>
          <div class="service-price">$599</div>
          <div class="service-description">Complete professional analysis</div>
          <ul class="service-features">
            <li>Everything in Basic, PLUS:</li>
            <li>BUY/DON'T BUY recommendation</li>
            <li>Professional valuation</li>
            <li>Recall & CarJam check</li>
            <li>10+ page detailed report</li>
            <li>Report within 60-90 minutes</li>
          </ul>
          
          <div style="background:#d4edda;border:3px solid #28a745;border-radius:12px;padding:18px;margin-top:20px;text-align:left;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
              <div style="background:#28a745;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;flex-shrink:0;">‚úì</div>
              <div style="font-weight:800;font-size:1.1em;color:#155724;">Protected If It's A Lemon</div>
            </div>
            <p style="margin:0;font-size:.95em;color:#155724;line-height:1.5;">If the mechanic identifies it's a lemon during inspection, we issue a <strong>$300 store credit</strong> (keeping only the $299 inspection cost). Use the credit on your next vehicle. You never lose money on a bad car.</p>
          </div>
          
          <div class="service-savings">
            Saves $3,200+ on average by avoiding bad purchases
          </div>
        </div>
      </div>

      <div style="text-align:center;margin:30px 0;">
        <button class="button" onclick="goToStep2()">See Availability ‚Üí</button>
      </div>
    </div>

    <!-- Step 2: Your Information -->
    <div class="step" id="step2">
      <div style="text-align:center;margin:0 0 20px 0;">
        <img src="/sweet-ride.png" alt="Professional vehicle inspection" style="max-width:300px;height:auto;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);" />
      </div>
      
      <div style="background:linear-gradient(135deg,#ff5500,#ff7733);border-radius:12px;padding:25px;margin-bottom:25px;text-align:center;color:#fff;">
        <h2 style="margin:0 0 10px 0;font-size:1.6em;">We Inspect Today - Not Next Week</h2>
        <p style="margin:0;font-size:1.05em;opacity:.95;">Other inspection services make you wait 2-3 days. We inspect same-day and deliver your report within 90 minutes. Don't lose the car while waiting.</p>
      </div>

      <div class="info-box">
        <h4>Why this inspection matters:</h4>
        <p>20% of vehicles we inspect are rejected ‚Ä¢ 40% have unaddressed safety recalls ‚Ä¢ 25% have electrical problems ‚Ä¢ Buyers save an average of $3,200 by avoiding bad purchases</p>
      </div>

      <div class="contact-info">
        <label for="nameInput">Full Name *</label>
        <div class="input-wrapper">
          <input type="text" id="nameInput" placeholder="John Smith" required autocomplete="name"/>
        </div>
        
        <label for="phoneInput">Phone Number *</label>
        <div class="input-wrapper">
          <input type="tel" id="phoneInput" placeholder="021 234 5678" required inputmode="tel" autocomplete="tel"/>
        </div>
        
        <label for="emailInput">Email Address *</label>
        <div class="input-wrapper">
          <input type="email" id="emailInput" placeholder="your.email@example.com" required autocomplete="email"/>
        </div>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button secondary" onclick="goToStep1()">‚Üê Back</button>
        <button class="button" onclick="goToStep3()">Continue to Vehicle Details ‚Üí</button>
      </div>
    </div>

    <!-- Step 3: Vehicle Information -->
    <div class="step" id="step3">
      <div style="text-align:center;margin:0 0 20px 0;">
        <img src="/sweet-ride.png" alt="Professional vehicle inspection" style="max-width:300px;height:auto;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);" />
      </div>
      
      <div style="background:linear-gradient(135deg,#17a2b8,#20c997);border-radius:12px;padding:25px;margin-bottom:25px;text-align:center;color:#fff;">
        <h2 style="margin:0 0 10px 0;font-size:1.6em;">Workshop Hoist Inspection - Not Driveway Mobile</h2>
        <p style="margin:0;font-size:1.05em;opacity:.95;">Mobile inspections can't see rust, exhaust leaks, or undercarriage damage. Our workshop hoists catch what mobile services miss. We assign a workshop within 10 minutes of the vehicle.</p>
      </div>

      <div class="contact-info">
        <label for="regoInput">Registration</label>
        <div class="input-wrapper">
          <input type="text" id="regoInput" placeholder="ABC123" style="text-transform:uppercase;" autocapitalize="characters" spellcheck="false"/>
        </div>
        
        <label for="yearInput">Year</label>
        <div class="input-wrapper">
          <input type="text" id="yearInput" placeholder="2018" maxlength="4" pattern="\\d{4}" inputmode="numeric"/>
        </div>
        
        <label for="makeInput">Make</label>
        <div class="input-wrapper">
          <input type="text" id="makeInput" placeholder="Toyota"/>
        </div>
        
        <label for="modelInput">Model</label>
        <div class="input-wrapper">
          <input type="text" id="modelInput" placeholder="Corolla"/>
        </div>
        
        <label for="locationInput">Where is the vehicle located? *</label>
        <div class="input-wrapper">
          <input type="text" id="locationInput" placeholder="Auckland CBD, Christchurch, Wellington..." required/>
        </div>
        <p style="color:#666;margin:-10px 0 15px 0;font-size:.9em;"><strong>600+ workshops nationwide.</strong> We'll assign you to the closest one (typically within 10 minutes).</p>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button secondary" onclick="goToStep2()">‚Üê Back</button>
        <button class="button" onclick="goToStep4()">Continue to Seller Info ‚Üí</button>
      </div>
    </div>

    <!-- Step 4: Seller Information -->
    <div class="step" id="step4">
      <div style="text-align:center;margin:0 0 20px 0;">
        <img src="/sweet-ride.png" alt="Professional vehicle inspection" style="max-width:300px;height:auto;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);" />
      </div>
      
      <div style="background:linear-gradient(135deg,#fd7e14,#ffc107);border-radius:12px;padding:25px;margin-bottom:25px;text-align:center;color:#fff;">
        <h2 style="margin:0 0 10px 0;font-size:1.6em;">If The Seller Refuses, The Car Is Probably A Lemon</h2>
        <p style="margin:0;font-size:1.05em;opacity:.95;">Honest sellers always cooperate. If they refuse our workshop inspection, we give you a full store credit to use on your next vehicle. You either get a thorough inspection, or you get your money back to avoid a lemon. Win-win.</p>
      </div>

      <div class="highlight-box">
        <h4>What happens next:</h4>
        <p>We contact the seller to arrange workshop drop-off. Legitimate sellers cooperate immediately - they know their vehicle will pass. If a seller refuses, that's a red flag: they're likely hiding something costly. When that happens, we give you full store credit to use on your next inspection. You just avoided a major expense.</p>
      </div>

      <div class="contact-info">
        <label for="sellerNameInput">Seller Name *</label>
        <div class="input-wrapper">
          <input type="text" id="sellerNameInput" placeholder="Seller's name or dealership" required/>
        </div>
        
        <label for="sellerPhoneInput">Seller Phone *</label>
        <div class="input-wrapper">
          <input type="tel" id="sellerPhoneInput" placeholder="021 987 6543" required inputmode="tel"/>
        </div>
        
        <label for="detailsInput">Additional details (optional)</label>
        <textarea id="detailsInput" placeholder="Any specific concerns, known issues, traveling from out of town..."></textarea>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button secondary" onclick="goToStep3()">‚Üê Back</button>
        <button class="button" onclick="goToStep5()">Continue to Select Day ‚Üí</button>
      </div>
    </div>

    <!-- Step 5: Day Selection -->
    <div class="step" id="step5">
      <div style="text-align:center;margin:0 0 20px 0;">
        <img src="/sweet-ride.png" alt="Professional vehicle inspection" style="max-width:300px;height:auto;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);" />
      </div>
      
      <div style="background:linear-gradient(135deg,#6f42c1,#e83e8c);border-radius:12px;padding:25px;margin-bottom:25px;text-align:center;color:#fff;">
        <h2 style="margin:0 0 10px 0;font-size:1.6em;">Saturday & Sunday Available - Other Services Aren't</h2>
        <p style="margin:0;font-size:1.05em;opacity:.95;">Found the perfect car on the weekend? Don't wait until Monday while another buyer snaps it up. We inspect Saturdays and Sundays.</p>
      </div>

      <div class="competitor-box">
        <h4>Our Availability Advantage:</h4>
        <p><strong>Other services:</strong> 24-48 hour advance booking, weekday-only, no weekends</p>
        <p><strong>We're available:</strong> Same-day bookings, Saturday & Sunday service</p>
      </div>

      <div id="daySelector" class="day-selector"></div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button secondary" onclick="goToStep4()">‚Üê Back</button>
        <button class="button" id="confirmDayBtn" onclick="goToStep6()" disabled>Continue to Vehicle Type ‚Üí</button>
      </div>
    </div>

    <!-- Step 6: Vehicle Type -->
    <div class="step" id="step6">
      <div style="text-align:center;margin:0 0 20px 0;">
        <img src="/sweet-ride.png" alt="Professional vehicle inspection" style="max-width:300px;height:auto;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);" />
      </div>
      
      <div style="background:linear-gradient(135deg,#28a745,#20c997);border-radius:12px;padding:25px;margin-bottom:25px;text-align:center;color:#fff;">
        <h2 style="margin:0 0 10px 0;font-size:1.6em;">95% Of Vehicles Are Standard Pricing</h2>
        <p style="margin:0;font-size:1.05em;opacity:.95;">No hidden fees. Most cars, SUVs, utes, and motorhomes are included in the base price. Only specialty vehicles cost extra.</p>
      </div>

      <div class="vehicle-types">
        <div class="vehicle-type popular selected" onclick="selectVehicleType('standard', 0, this)">
          <div class="vehicle-type-title">Standard Vehicle</div>
          <div class="vehicle-type-subtitle">Cars, SUVs, utes, motorhomes with standard license</div>
          <div class="vehicle-note" style="color:#28a745;font-weight:700;">No additional fee</div>
        </div>

        <div class="vehicle-type" onclick="selectVehicleType('specialty', 129, this)">
          <div class="vehicle-type-title">Classic/Specialty</div>
          <div class="vehicle-type-subtitle">Classics, modified vehicles, rare imports</div>
          <div class="vehicle-note">Specialist expertise (+$129)</div>
        </div>
      </div>

      <div style="background:#f8f9fa;border-radius:8px;padding:15px;margin:20px 0;text-align:left;">
        <p style="margin:0;color:#495057;font-size:.9em;line-height:1.5;"><strong>Note:</strong> We inspect vehicles with standard licenses. Heavy truck (HT) licenses and commercial trucks requiring special licenses are not available for inspection through this service.</p>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button secondary" onclick="goToStep5()">‚Üê Back</button>
        <button class="button" onclick="goToStep7()">Review Your Booking ‚Üí</button>
      </div>
    </div>

    <!-- Step 7: Confirm -->
    <div class="step" id="step7">
      <div style="text-align:center;margin:0 0 20px 0;">
        <img src="/sweet-ride.png" alt="Professional vehicle inspection" style="max-width:300px;height:auto;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);" />
      </div>
      
      <div style="background:linear-gradient(135deg,#dc3545,#c82333);border-radius:12px;padding:25px;margin-bottom:25px;text-align:center;color:#fff;">
        <h2 style="margin:0 0 10px 0;font-size:1.6em;"><span id="dynamicPrice">$599</span> Today Could Save You $3,200 Tomorrow</h2>
        <p style="margin:0;font-size:1.05em;opacity:.95;">25% of vehicles have electrical problems costing thousands. 40% have unaddressed recalls. Know what you're buying before you pay.</p>
      </div>

      <div class="trust-badges">
        <div class="trust-badge">
          <div class="trust-badge-icon">üîí</div>
          <div class="trust-badge-text">Secure Payment</div>
        </div>
        <div class="trust-badge">
          <div class="trust-badge-icon">‚è±Ô∏è</div>
          <div class="trust-badge-text">60-90min Report</div>
        </div>
        <div class="trust-badge">
          <div class="trust-badge-icon">üèÜ</div>
          <div class="trust-badge-text">Workshop Hoist Inspection</div>
        </div>
      </div>

      <div class="reservation-summary">
        <h4>Your Inspection Booking</h4>
        <div class="summary-item"><span>Service:</span><strong id="summaryService"></strong></div>
        <div class="summary-item"><span>Your Phone:</span><strong id="summaryPhone"></strong></div>
        <div class="summary-item"><span>Vehicle Location:</span><strong id="summaryLocation"></strong></div>
        <div class="summary-item"><span>Inspection Day:</span><strong id="summaryDate"></strong></div>
        <div class="summary-item"><span>Vehicle Type:</span><strong id="summaryVehicle"></strong></div>
        <div class="summary-item" style="border-top:2px solid #bee5eb;margin-top:10px;padding-top:10px;font-size:1.15em;"><span>Total Fee:</span><strong id="summaryPrice" style="font-size:1.4em;"></strong></div>
      </div>

      <div class="info-box">
        <h4>What Happens Next:</h4>
        <p><strong>1.</strong> Complete payment through secure Stripe checkout</p>
        <p><strong>2.</strong> We contact you within 30 minutes to confirm</p>
        <p><strong>3.</strong> We coordinate with vehicle owner for workshop drop-off</p>
        <p><strong>4.</strong> Inspection completed on your selected day</p>
        <p id="reportTimingNote"><strong>5.</strong> Report delivered within 60-90 minutes</p>
      </div>

      <div class="terms-section">
        <h4>Terms and Conditions</h4>
        <div class="terms-checkbox">
          <input type="checkbox" id="termsAgree" onchange="toggleBookingButton()" />
          <div class="terms-text">
            I understand the <a href="https://eek.nz/terms" target="_blank">booking policies</a> - inspection is at assigned workshop, vehicle owner brings vehicle, and inspection fee is non-refundable once service is completed.
          </div>
        </div>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button secondary" onclick="goToStep6()">‚Üê Back</button>
        <button class="button" id="generatePaymentBtn" onclick="generatePaymentLink()" disabled style="font-size:1.15em;padding:16px 32px;">Secure My Inspection Now ‚Üí</button>
        <p style="margin:15px 0;color:#666;font-size:.9em;">üîí Secure payment processing powered by Stripe</p>
      </div>
    </div>
  </div>
</div>

<!-- Exit Intent Popup -->
<div class="exit-popup" id="exitPopup">
  <div class="exit-popup-content">
    <button class="exit-popup-close" onclick="closeExitPopup()">√ó</button>
    <h2 style="color:#dc3545;margin:0 0 15px 0;font-size:1.8em;">Wait! Don't Risk Buying a Lemon</h2>
    <p style="font-size:1.15em;margin:0 0 20px 0;line-height:1.5;">Complete your booking in the next <strong>30 minutes</strong> and save <strong id="exitDiscount">$40</strong> on your inspection.</p>
    <div style="background:#fff3cd;padding:15px;border-radius:8px;margin:0 0 20px 0;">
      <p style="margin:0;color:#856404;font-size:.95em;">‚ö†Ô∏è <strong>1 in 5 vehicles</strong> we inspect gets rejected. Don't gamble with a bad car.</p>
    </div>
    <button class="button" onclick="closeExitPopup()" style="font-size:1.2em;padding:16px 32px;">Continue Booking & Save <span id="exitDiscountBtn">$40</span> ‚Üí</button>
    <p style="margin:15px 0 0 0;color:#999;font-size:.85em;">Limited time offer - expires in 30 minutes</p>
  </div>
</div>

<script>
// CENTRALIZED GCLID EXTRACTION
function extractGCLID(urlParams) {
  return urlParams.get('gclid') || urlParams.get('gbraid') || urlParams.get('wbraid') || null;
}

console.log('üöÄ === OPTIMIZED PRE-PURCHASE INSPECTION FORM (7-STEP) LOADED === üöÄ');

// === TRACKING ===
let sessionId = null;
let gclid = null;
let utmData = {};

function initializeTracking() {
  sessionId = getOrCreateSessionId();
  gclid = getGCLID();
  utmData = getUTMData();
  console.log('‚úÖ Tracking initialized - Session:', sessionId, 'GCLID:', gclid);
}

function getOrCreateSessionId() {
  let sid = localStorage.getItem("eek_session_id");
  if (!sid) {
    const urlParams = new URLSearchParams(window.location.search);
    sid = urlParams.get('session_id') || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem("eek_session_id", sid);
  }
  return sid;
}

function getGCLID() {
  const urlParams = new URLSearchParams(window.location.search);
  let gclidValue = extractGCLID(urlParams);
  if (gclidValue) {
    localStorage.setItem("eek_gclid", gclidValue);
    localStorage.setItem("eek_gclid_timestamp", new Date().toISOString());
    return gclidValue;
  }
  const storedGclid = localStorage.getItem("eek_gclid");
  const storedTimestamp = localStorage.getItem("eek_gclid_timestamp");
  if (storedGclid && storedTimestamp) {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    if (new Date(storedTimestamp) > thirtyDaysAgo) return storedGclid;
    localStorage.removeItem("eek_gclid");
    localStorage.removeItem("eek_gclid_timestamp");
  }
  return null;
}

function getUTMData() {
  const urlParams = new URLSearchParams(window.location.search);
  const utm = {};
  const utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];
  utmParams.forEach(param => {
    const value = urlParams.get(param);
    if (value) {
      utm[param] = value;
      localStorage.setItem(`eek_${param}`, value);
    } else {
      const stored = localStorage.getItem(`eek_${param}`);
      if (stored) utm[param] = stored;
    }
  });
  return utm;
}

// === BOOKING STATUS ===
const BOOKING_STATUS = {
  INITIAL: 'booking_started',
  SERVICE_SELECTED: 'service_selected',
  CONTACT_INFO: 'contact_info_complete',
  VEHICLE_INFO: 'vehicle_info_complete',
  SELLER_INFO: 'seller_info_complete',
  DAY_SELECTED: 'day_selected',
  VEHICLE_TYPE: 'vehicle_type_selected',
  TERMS_ACCEPTED: 'terms_accepted',
  PAYMENT_PENDING: 'payment_pending'
};

const STATUS_COLORS = {
  'booking_started': '#007bff',
  'service_selected': '#17a2b8',
  'contact_info_complete': '#20c997',
  'vehicle_info_complete': '#28a745',
  'seller_info_complete': '#fd7e14',
  'day_selected': '#6f42c1',
  'vehicle_type_selected': '#e83e8c',
  'terms_accepted': '#20c997',
  'payment_pending': '#dc3545'
};

// NZ TIMEZONE
const NZ_TZ = 'Pacific/Auckland';
function nowNZ() {
  const parts = new Intl.DateTimeFormat('en-NZ', {
    timeZone: NZ_TZ, hour12: false,
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).formatToParts(new Date());
  const get = t => parts.find(p => p.type === t).value;
  return new Date(`${get('year')}-${get('month')}-${get('day')}T${get('hour')}:${get('minute')}:${get('second')}`);
}

function fmtDateNZ(d){
  return d.toLocaleDateString('en-NZ', { timeZone: NZ_TZ, weekday:'long', year:'numeric', month:'long', day:'numeric' });
}

function getDayName(d){
  return d.toLocaleDateString('en-NZ', { timeZone: NZ_TZ, weekday:'long' });
}

// API URLS
const POWER_AUTOMATE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/dbc93a177083499caf5a06eeac87683c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vXidGdo8qErY4QVv03JeNaGbA79eWEoiOxuDocljL6Q';
const PRICING_API_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2f31c90260554c5a9d6dcffec47bc6c2/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Ou7iqzZ1YI2PzT_9X-M6PT5iVo2QRboWnFZrO3IBOL4';

// STATE
let selectedService = 'comprehensive';
let selectedServicePrice = 599;
let selectedDay = null;
let selectedDayString = '';
let selectedVehicleType = 'standard';
let vehicleTypeAddon = 0;

// EXIT INTENT STATE
let exitIntentShown = false;
let exitIntentTimer = null;

// HELPERS
function sanitizePhone(val){ return (val || '').replace(/\D/g,''); }
function sanitizeRego(val){ return (val || '').toUpperCase().replace(/\s+/g,''); }
function sanitizeText(val){ return (val || '').trim().replace(/\s+/g,' '); }

// === FIELD VALIDATION ===
function setupFieldValidation() {
  const fields = ['nameInput', 'phoneInput', 'emailInput', 'locationInput', 'sellerNameInput', 'sellerPhoneInput'];
  
  fields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('blur', function() {
        validateField(this);
      });
      
      // Clear validation on focus
      field.addEventListener('focus', function() {
        this.classList.remove('valid', 'error');
        const wrapper = this.closest('.input-wrapper');
        if (wrapper) {
          const check = wrapper.querySelector('.validation-check');
          if (check) check.remove();
        }
      });
    }
  });
}

function validateField(field) {
  let isValid = false;
  const value = field.value.trim();
  
  if (field.id.includes('email')) {
    isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  } else if (field.id.includes('Phone')) {
    isValid = /^[\d\s\-\+\(\)]+$/.test(value) && value.replace(/\D/g,'').length >= 9;
  } else if (field.required || field.id === 'locationInput') {
    isValid = value.length > 0;
  } else {
    return; // Don't validate optional fields
  }
  
  if (isValid) {
    field.classList.remove('error');
    field.classList.add('valid');
    
    // Add checkmark
    const wrapper = field.closest('.input-wrapper');
    if (wrapper && !wrapper.querySelector('.validation-check')) {
      const check = document.createElement('span');
      check.className = 'validation-check';
      check.textContent = '‚úì';
      wrapper.appendChild(check);
    }
  } else if (value.length > 0) {
    field.classList.remove('valid');
    field.classList.add('error');
  }
}

// === EXIT INTENT ===
function initExitIntent() {
  document.addEventListener('mouseleave', function(e) {
    if (e.clientY < 0 && !exitIntentShown) {
      const currentStep = parseInt(document.querySelector('.step.active').id.replace('step', ''));
      if (currentStep > 1 && currentStep < 7) {
        showExitIntent(currentStep);
      }
    }
  });
}

function showExitIntent(currentStep) {
  exitIntentShown = true;
  const discount = currentStep >= 6 ? 40 : 20;
  
  document.getElementById('exitDiscount').textContent = `$${discount}`;
  document.getElementById('exitDiscountBtn').textContent = `$${discount}`;
  document.getElementById('exitPopup').classList.add('show');
  
  // Set timer to hide after 30 seconds if not interacted with
  exitIntentTimer = setTimeout(() => {
    closeExitPopup();
  }, 30000);
}

function closeExitPopup() {
  document.getElementById('exitPopup').classList.remove('show');
  if (exitIntentTimer) {
    clearTimeout(exitIntentTimer);
    exitIntentTimer = null;
  }
}

// === SERVICE SELECTION ===
function selectService(type, price, element) {
  document.querySelectorAll('.service-option.selected').forEach(el => el.classList.remove('selected'));
  element.classList.add('selected');
  selectedService = type;
  selectedServicePrice = price;
  console.log('üìã Service selected:', type, '$' + price);
}

// === DATA BUILDER ===
function buildInspectionData(status) {
  return {
    sessionId, gclid,
    bookingStatus: status,
    statusColor: STATUS_COLORS[status] || '#6c757d',
    timestamp: new Date().toISOString(),
    
    name: sanitizeText(document.getElementById('nameInput').value),
    phone: sanitizePhone(document.getElementById('phoneInput').value),
    email: document.getElementById('emailInput').value.trim(),
    location: sanitizeText(document.getElementById('locationInput').value),
    details: document.getElementById('detailsInput').value || '',
    
    rego: sanitizeRego(document.getElementById('regoInput').value),
    vehicleRego: sanitizeRego(document.getElementById('regoInput').value),
    year: document.getElementById('yearInput').value.trim(),
    vehicleYear: document.getElementById('yearInput').value.trim(),
    make: sanitizeText(document.getElementById('makeInput').value),
    vehicleMake: sanitizeText(document.getElementById('makeInput').value),
    model: sanitizeText(document.getElementById('modelInput').value),
    vehicleModel: sanitizeText(document.getElementById('modelInput').value),
    vehicleType: selectedVehicleType,
    batteryVoltage: '',
    
    sellerName: sanitizeText(document.getElementById('sellerNameInput').value),
    sellerPhone: sanitizePhone(document.getElementById('sellerPhoneInput').value),
    
    service: selectedService === 'basic' ? 'inspection_basic' : 'inspection_comprehensive',
    serviceCode: selectedService === 'basic' ? 'INSP_BASIC' : 'INSP_COMP',
    serviceTitle: selectedService === 'basic' ? 'Basic Mechanical Inspection' : 'Comprehensive Pre-Purchase Report',
    serviceTier: selectedService,
    basePrice: selectedServicePrice,
    
    scheduledDate: selectedDayString,
    scheduledDateISO: selectedDay ? selectedDay.toISOString() : '',
    scheduledDateNZ: selectedDay ? selectedDay.toLocaleString('sv-SE', { timeZone: NZ_TZ, hour12: false }) : '',
    timeWindow: 'Flexible same-day',
    timeWindowId: 'same-day-flexible',
    
    selectedVehicleType,
    vehicleTypeAddon,
    totalPrice: selectedServicePrice + vehicleTypeAddon,
    calculatedPrice: selectedServicePrice + vehicleTypeAddon,
    finalPrice: selectedServicePrice + vehicleTypeAddon,
    price: String(selectedServicePrice + vehicleTypeAddon),
    
    urgencyLevel: 'Same-Day',
    emergencyType: '',
    quoteReference: '',
    isWinz: 'false',
    
    utm: {
      source: utmData.utm_source || null,
      medium: utmData.utm_medium || null,
      campaign: utmData.utm_campaign || null,
      term: utmData.utm_term || null,
      content: utmData.utm_content || null,
      gclid
    },
    
    source: 'inspection_booking_form',
    formVersion: '5.1'
  };
}

async function sendInspectionUpdate(status) {
  const data = buildInspectionData(status);
  console.log(`üì° ${status}:`, data);
  try {
    const response = await fetch(PRICING_API_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    console.log(`‚úÖ API Response: ${response.status}`);
    return response;
  } catch (err) {
    console.error(`‚ùå Error:`, err);
  }
}

// === NAVIGATION ===
function updateProgress(currentStep) {
  document.querySelectorAll('.progress-step').forEach((el, idx) => {
    el.classList.remove('active', 'completed');
    if (idx + 1 < currentStep) el.classList.add('completed');
    if (idx + 1 === currentStep) el.classList.add('active');
  });
}

function showStep(stepNum) {
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step' + stepNum).classList.add('active');
  updateProgress(stepNum);
  
  // Hide main header/banner after step 1
  if (stepNum > 1) {
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('mainBreadcrumb').style.display = 'none';
    document.getElementById('mainBanner').style.display = 'none';
  } else {
    document.getElementById('mainHeader').style.display = 'block';
    document.getElementById('mainBreadcrumb').style.display = 'block';
    document.getElementById('mainBanner').style.display = 'block';
  }
  
  window.scrollTo(0, 0);
}

function goToStep1() { showStep(1); }

async function goToStep2() {
  await sendInspectionUpdate(BOOKING_STATUS.SERVICE_SELECTED);
  showStep(2);
}

async function goToStep3() {
  document.querySelectorAll('.contact-info input').forEach(input => input.classList.remove('error'));
  document.querySelectorAll('.error-message').forEach(msg => msg.classList.remove('show'));
  
  const name = document.getElementById('nameInput').value.trim();
  const phone = document.getElementById('phoneInput').value.trim();
  const email = document.getElementById('emailInput').value.trim();
  
  let firstErrorField = null;
  
  if (!name) { showInlineError('nameInput', 'Please enter your full name'); firstErrorField = firstErrorField || document.getElementById('nameInput'); }
  if (!phone) { showInlineError('phoneInput', 'Please enter your phone number'); firstErrorField = firstErrorField || document.getElementById('phoneInput'); }
  else if (!/^[\d\s\-\+\(\)]+$/.test(phone) || phone.replace(/\D/g,'').length < 9) { showInlineError('phoneInput', 'Please enter a valid phone number'); firstErrorField = firstErrorField || document.getElementById('phoneInput'); }
  if (!email) { showInlineError('emailInput', 'Please enter your email'); firstErrorField = firstErrorField || document.getElementById('emailInput'); }
  else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showInlineError('emailInput', 'Please enter a valid email'); firstErrorField = firstErrorField || document.getElementById('emailInput'); }
  
  if (firstErrorField) {
    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
    firstErrorField.focus();
    showNotification('Required Fields', 'Please correct the errors highlighted', 'error');
    return;
  }
  
  await sendInspectionUpdate(BOOKING_STATUS.CONTACT_INFO);
  showStep(3);
}

async function goToStep4() {
  document.querySelectorAll('.contact-info input').forEach(input => input.classList.remove('error'));
  document.querySelectorAll('.error-message').forEach(msg => msg.classList.remove('show'));
  
  const location = document.getElementById('locationInput').value.trim();
  
  if (!location) {
    showInlineError('locationInput', 'Please enter vehicle location');
    document.getElementById('locationInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
    document.getElementById('locationInput').focus();
    showNotification('Required Field', 'Please enter vehicle location', 'error');
    return;
  }
  
  await sendInspectionUpdate(BOOKING_STATUS.VEHICLE_INFO);
  showStep(4);
}

async function goToStep5() {
  document.querySelectorAll('.contact-info input').forEach(input => input.classList.remove('error'));
  document.querySelectorAll('.error-message').forEach(msg => msg.classList.remove('show'));
  
  const sellerName = document.getElementById('sellerNameInput').value.trim();
  const sellerPhone = document.getElementById('sellerPhoneInput').value.trim();
  
  let firstErrorField = null;
  
  if (!sellerName) { showInlineError('sellerNameInput', 'Please enter seller name'); firstErrorField = firstErrorField || document.getElementById('sellerNameInput'); }
  if (!sellerPhone) { showInlineError('sellerPhoneInput', 'Please enter seller phone'); firstErrorField = firstErrorField || document.getElementById('sellerPhoneInput'); }
  else if (!/^[\d\s\-\+\(\)]+$/.test(sellerPhone) || sellerPhone.replace(/\D/g,'').length < 9) { showInlineError('sellerPhoneInput', 'Please enter a valid phone number'); firstErrorField = firstErrorField || document.getElementById('sellerPhoneInput'); }
  
  if (firstErrorField) {
    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
    firstErrorField.focus();
    showNotification('Required Fields', 'Please correct the errors', 'error');
    return;
  }
  
  await sendInspectionUpdate(BOOKING_STATUS.SELLER_INFO);
  showStep(5);
}

async function goToStep6() {
  if (!selectedDay) {
    showNotification('Selection Required', 'Please select a day', 'error');
    return;
  }
  await sendInspectionUpdate(BOOKING_STATUS.DAY_SELECTED);
  showStep(6);
}

async function goToStep7() {
  await sendInspectionUpdate(BOOKING_STATUS.VEHICLE_TYPE);
  updateSummary();
  showStep(7);
}

function showInlineError(inputId, message) {
  const input = document.getElementById(inputId);
  input.classList.add('error');
  let errorMsg = input.parentElement.querySelector('.error-message');
  if (!errorMsg) {
    errorMsg = document.createElement('div');
    errorMsg.className = 'error-message';
    input.parentElement.appendChild(errorMsg);
  }
  errorMsg.textContent = message;
  errorMsg.classList.add('show');
}

// === DAY SELECTOR ===
function initializeDaySelector() {
  const today = nowNZ();
  const dayOfWeek = today.getDay();
  const container = document.getElementById('daySelector');
  let options = [];
  
  if (dayOfWeek >= 1 && dayOfWeek <= 5) {
    const todayDate = new Date(today);
    options.push({day: todayDate, title: 'Today', subtitle: getDayName(todayDate), description: 'Inspection completed today', featured: true});
    
    const daysUntilSaturday = (6 - dayOfWeek + 7) % 7 || 7;
    const saturdayDate = new Date(today);
    saturdayDate.setDate(saturdayDate.getDate() + daysUntilSaturday);
    options.push({day: saturdayDate, title: 'This Saturday', subtitle: saturdayDate.toLocaleDateString('en-NZ', {timeZone: NZ_TZ, month: 'long', day: 'numeric'}), description: 'Weekend inspection available', featured: false});
    
    const daysUntilSunday = (7 - dayOfWeek + 7) % 7 || 7;
    const sundayDate = new Date(today);
    sundayDate.setDate(sundayDate.getDate() + daysUntilSunday);
    options.push({day: sundayDate, title: 'This Sunday', subtitle: sundayDate.toLocaleDateString('en-NZ', {timeZone: NZ_TZ, month: 'long', day: 'numeric'}), description: 'Weekend inspection available', featured: false});
  } else if (dayOfWeek === 6) {
    const todayDate = new Date(today);
    options.push({day: todayDate, title: 'Today', subtitle: 'Saturday', description: 'Weekend inspection', featured: true});
    const sundayDate = new Date(today);
    sundayDate.setDate(sundayDate.getDate() + 1);
    options.push({day: sundayDate, title: 'Tomorrow', subtitle: 'Sunday', description: 'Weekend inspection', featured: false});
  } else {
    const todayDate = new Date(today);
    options.push({day: todayDate, title: 'Today', subtitle: 'Sunday', description: 'Weekend inspection', featured: true});
  }
  
  container.innerHTML = options.map((opt, idx) => {
    const featuredClass = opt.featured ? 'featured' : '';
    const selectedClass = idx === 0 ? 'selected' : '';
    return `<div class="day-option ${featuredClass} ${selectedClass}" data-day="${opt.day.toISOString()}" data-string="${fmtDateNZ(opt.day)}" onclick="selectDay('${opt.day.toISOString()}', '${fmtDateNZ(opt.day)}', this)">
      <div class="day-title">${opt.title}</div>
      <div class="day-subtitle">${opt.subtitle}</div>
      <div class="day-description">${opt.description}</div>
    </div>`;
  }).join('');
  
  if (options.length > 0) {
    selectedDay = options[0].day;
    selectedDayString = fmtDateNZ(options[0].day);
    document.getElementById('confirmDayBtn').disabled = false;
  }
}

function selectDay(dayISO, dayString, element){
  document.querySelectorAll('.day-option.selected').forEach(el => el.classList.remove('selected'));
  element.classList.add('selected');
  selectedDay = new Date(dayISO);
  selectedDayString = dayString;
  document.getElementById('confirmDayBtn').disabled = false;
}

function selectVehicleType(type, addon, el){
  document.querySelectorAll('.vehicle-type.selected').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  selectedVehicleType = type;
  vehicleTypeAddon = addon;
}

function updateSummary(){
  const serviceNames = {'basic': 'Basic Mechanical', 'comprehensive': 'Comprehensive Report'};
  const vehicleNames = {'standard': 'Standard Vehicle', 'specialty': 'Classic/Specialty (+$129)'};
  
  const totalPrice = selectedServicePrice + vehicleTypeAddon;
  
  document.getElementById('summaryService').textContent = serviceNames[selectedService];
  document.getElementById('summaryPhone').textContent = document.getElementById('phoneInput').value;
  document.getElementById('summaryLocation').textContent = document.getElementById('locationInput').value;
  document.getElementById('summaryDate').textContent = selectedDayString;
  document.getElementById('summaryVehicle').textContent = vehicleNames[selectedVehicleType];
  document.getElementById('summaryPrice').textContent = `$${totalPrice}`;
  
  // Update dynamic price in red block
  document.getElementById('dynamicPrice').textContent = `$${totalPrice}`;
  
  document.getElementById('reportTimingNote').innerHTML = selectedService === 'basic' ? '<strong>5.</strong> Report delivered immediately' : '<strong>5.</strong> Report within 60-90 minutes';
}

function toggleBookingButton(){
  document.getElementById('generatePaymentBtn').disabled = !document.getElementById('termsAgree').checked;
}

function buildRedirectUrl(){
  const params = new URLSearchParams();
  params.append('name', sanitizeText(document.getElementById('nameInput').value));
  params.append('phone', sanitizePhone(document.getElementById('phoneInput').value));
  params.append('email', document.getElementById('emailInput').value.trim());
  params.append('location', sanitizeText(document.getElementById('locationInput').value));
  params.append('service', selectedService === 'basic' ? 'inspection_basic' : 'inspection_comprehensive');
  params.append('price', selectedServicePrice + vehicleTypeAddon);
  if (sessionId) params.append('session_id', sessionId);
  if (gclid) params.append('gclid', gclid);
  return `https://www.eek.nz/thanks?${params.toString()}`;
}

async function generatePaymentLink(){
  const btn = document.getElementById('generatePaymentBtn');
  if (!document.getElementById('termsAgree').checked) {
    showNotification('Terms Required', 'Please accept the terms', 'error');
    return;
  }
  
  btn.disabled = true; btn.classList.add('processing'); btn.textContent='Processing...';
  await sendInspectionUpdate(BOOKING_STATUS.TERMS_ACCEPTED);
  
  const total = selectedServicePrice + vehicleTypeAddon;
  const serviceTitle = selectedService === 'basic' ? 'Basic Mechanical Inspection' : 'Comprehensive Pre-Purchase Report';
  
  const bookingData = {
    amount: total * 100,
    currency: 'NZD',
    description: `${serviceTitle} - ${document.getElementById('locationInput').value}`,
    redirectUrl: buildRedirectUrl(),
    customerData: {
      ...buildInspectionData(BOOKING_STATUS.PAYMENT_PENDING),
      bookingDateTime: nowNZ().toLocaleString('en-NZ', { timeZone: NZ_TZ })
    }
  };
  
  try{
    const response = await fetch(POWER_AUTOMATE_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(bookingData)});
    if (response.ok){
      const result = await response.json();
      if (result.url){
        btn.style.display='none';
        const successDiv = document.createElement('div');
        successDiv.style.cssText='background:#d4edda;border:3px solid #28a745;padding:25px;border-radius:12px;margin-top:20px;text-align:center;';
        successDiv.innerHTML = `<h4 style="color:#155724;margin:0 0 15px 0;font-size:1.3em;">‚úì Payment Link Ready!</h4><a href="${result.url}" class="button" style="background:#28a745;font-size:1.3em;padding:18px 36px;">Complete Secure Payment ($${total}) ‚Üí</a><p style="color:#666;font-size:.95em;margin-top:15px;line-height:1.5;">üîí Secure checkout powered by Stripe<br>We'll contact you within 30 minutes after payment</p>`;
        btn.parentElement.appendChild(successDiv);
        setTimeout(()=>{ window.location.href = result.url; },3000);
      } else throw new Error('No payment URL');
    } else throw new Error('Server error '+response.status);
  }catch(err){
    console.error(err);
    btn.disabled=false; btn.classList.remove('processing'); btn.textContent='Secure My Inspection Now ‚Üí';
    showNotification('Connection Error', 'Unable to generate link. Please try again', 'error');
  }
}

function showNotification(title, message, type = 'info') {
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  const iconMap = { error: '‚ö†', success: '‚úì', info: '‚Ñπ' };
  const wrap = document.createElement('div');
  wrap.className = 'notification ' + type;
  wrap.innerHTML = `<div class="notification-content"><div class="notification-icon">${iconMap[type]}</div><div class="notification-text"><strong>${title}</strong><br>${message}</div><button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button></div>`;
  document.body.appendChild(wrap);
  setTimeout(() => wrap.classList.add('show'), 100);
  setTimeout(() => wrap.remove(), 5000);
}

// INITIALIZE
document.addEventListener('DOMContentLoaded', function(){
  console.log('‚úÖ Optimized 7-Step Form Initialized (v5.1)');
  initializeTracking();
  sendInspectionUpdate(BOOKING_STATUS.INITIAL);
  initializeDaySelector();
  setupFieldValidation();
  initExitIntent();
});
</script>
</body>
</html>
