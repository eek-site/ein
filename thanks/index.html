<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment Confirmed - Thank You | Eek Mobile Mechanical</title>
  <meta name="description" content="Payment confirmed! Your mobile mechanic service is being dispatched. We'll contact you within minutes with your technician's details and arrival time." />
  <meta name="robots" content="noindex, nofollow" />
  <meta property="og:title" content="Payment Confirmed - Thank You | Eek Mobile Mechanical" />
  <meta property="og:description" content="Payment confirmed! Your mobile mechanic service is being dispatched." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.eek.nz/thanks" />
  <meta property="og:image" content="https://www.eek.nz/sweet-ride.png" />

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://www.redditstatic.com https://googleads.g.doubleclick.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com https://www.redditstatic.com https://pixel-config.reddit.com https://conversions-config.reddit.com https://www.googletagmanager.com https://googleads.g.doubleclick.net https://www.google.com https://www.googleadservices.com https://www.google.hn https://prod-22.australiasoutheast.logic.azure.com https://prod-26.australiasoutheast.logic.azure.com https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com; frame-src 'self' https://td.doubleclick.net https://www.googletagmanager.com;">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

  <!-- Reddit Pixel -->
  <script>
    !function(w,d){if(!w.rdt){var p=w.rdt=function(){p.sendEvent?p.sendEvent.apply(p,arguments):p.callQueue.push(arguments)};p.callQueue=[];var t=d.createElement("script");t.src="https://www.redditstatic.com/ads/pixel.js",t.async=!0;var s=d.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}}
    (window,document);
    rdt('init', 'a2_hf16791nsdhx');
    rdt('track', 'PageVisit');
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17084465163"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-17084465163');
    gtag('config', 'G-DQNKF1YLWR');
  </script>

  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f5f5f5 0%, #e8f5e8 100%);
      margin: 0; padding: 0; color: #333; text-align: center;
      min-height: 100vh; display: flex; flex-direction: column;
    }
    .container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
    .success-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); max-width: 700px; width: 100%; margin: 20px; position: relative; overflow: hidden; }
    .success-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #28a745, #20c997, #17a2b8); }
    .success-card.winz::before { background: linear-gradient(90deg, #6f42c1, #5a32a3, #8b5cf6); }
    .success-icon { font-size: 4em; color: #28a745; margin-bottom: 20px; animation: bounce 1s ease-in-out; }
    .success-icon.winz { color: #6f42c1; }
    @keyframes bounce { 0%,20%,50%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-20px)} 60%{transform:translateY(-10px)} }
    h1 { color: #28a745; font-size: 2.5em; margin: 0 0 10px 0; font-weight: 700; }
    h1.winz { color: #6f42c1; }
    .subtitle { font-size: 1.3em; color: #666; margin-bottom: 30px; font-weight: 500; }
    .booking-details { background: #f0f9ff; padding: 25px; border-radius: 15px; margin: 20px 0; border: 2px solid #0ea5e9; text-align: left; }
    .booking-details.winz { background: #f8f4ff; border-color: #6f42c1; }
    .booking-details h3 { color: #0369a1; margin-bottom: 15px; font-size: 1.3em; text-align: center; }
    .booking-details.winz h3 { color: #6f42c1; }
    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0f2fe; align-items: flex-start; }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-weight: 600; color: #64748b; flex-shrink: 0; min-width: 120px; }
    .detail-value { color: #0f172a; text-align: right; flex: 1; word-break: break-word; }
    .next-steps { background: #f8f9fa; padding: 30px; border-radius: 15px; margin: 30px 0; border-left: 5px solid #ff5500; }
    .next-steps.winz { border-left-color: #6f42c1; }
    .next-steps h2 { color: #ff5500; font-size: 1.5em; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .next-steps.winz h2 { color: #6f42c1; }
    .steps-list { text-align: left; margin: 0; padding: 0; list-style: none; }
    .steps-list li { padding: 12px 0; font-size: 1.1em; display: flex; align-items: flex-start; gap: 12px; }
    .step-number { background: #ff5500; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold; flex-shrink: 0; margin-top: 2px; }
    .next-steps.winz .step-number { background: #6f42c1; }
    .contact-info { background: #e3f2fd; padding: 25px; border-radius: 15px; margin: 30px 0; border: 2px solid #2196f3; }
    .contact-info.winz { background: #f0f4ff; border-color: #6f42c1; }
    .contact-info h3 { color: #1976d2; margin-bottom: 15px; font-size: 1.3em; }
    .contact-info.winz h3 { color: #6f42c1; }
    .contact-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
    .btn { display: inline-block; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1em; transition: all 0.3s ease; border: none; cursor: pointer; }
    .btn-primary { background: #ff5500; color: white; }
    .btn-primary:hover { background: #e64900; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,85,0,0.3); }
    .btn-winz { background: #6f42c1; color: white; }
    .btn-winz:hover { background: #5a32a3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(111,66,193,0.3); }
    .estimated-time { background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #ffc107; }
    .estimated-time .time-display { font-size: 2em; font-weight: bold; color: #856404; margin: 10px 0; }
    .additional-services { background: #f0f9ff; padding: 25px; border-radius: 15px; margin: 30px 0; border: 2px solid #0ea5e9; }
    .additional-services h3 { color: #0369a1; margin-bottom: 15px; font-size: 1.3em; }
    .service-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px; }
    .service-links a { background: white; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #0369a1; font-size: 0.9em; transition: all 0.3s ease; border: 1px solid #e0f2fe; }
    .service-links a:hover { background: #0ea5e9; color: white; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(14,165,233,0.2); }
    .footer-links { margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; }
    .footer-links a { color: #6c757d; text-decoration: none; margin: 0 15px; font-size: 0.9em; }
    .footer-links a:hover { color: #ff5500; text-decoration: underline; }
    .loading-animation { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #ff5500; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .processing-indicator { background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin: 15px 0; display: none; }
    @media (max-width:768px){
      .success-card{padding:30px 20px;margin:10px}
      h1{font-size:2em}
      .contact-buttons{flex-direction:column;align-items:center}
      .btn{width:100%;max-width:250px}
      .service-links{grid-template-columns:1fr}
      .detail-row{flex-direction:column;gap:4px}
      .detail-label{min-width:unset}
      .detail-value{text-align:left}
    }
  </style>
</head>
<body>
  <div class="container">
    <header style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
      <img src="https://www.eek.nz/sweet-ride.png" alt="Sweet! - Eek Mobile Mechanical Success" style="max-width: 300px; height: auto; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" />
      <h1 style="margin: 0.5em 0 0.2em; font-size: 2em;">Eek Mobile Mechanical</h1>
      <p style="font-size: 1.2em; color: #666; margin-bottom: 0;">NZ-Wide Mobile Mechanics</p>
    </header>

    <div class="success-card" id="successCard">
      <div class="success-icon" id="successIcon">‚úÖ</div>
      <h1 id="mainTitle">Payment Confirmed!</h1>
      <p class="subtitle" id="mainSubtitle">Your mobile mechanic is already on the way</p>

      <div class="processing-indicator" id="processingIndicator">‚úì Booking data sent successfully</div>

      <!-- Booking Details -->
      <div class="booking-details" id="bookingDetails">
        <h3>üìã Your Booking Details</h3>
        <div id="detailsContent"></div>
      </div>

      <!-- WINZ Quote Success Section -->
      <div id="winzSection" style="display: none;">
        <div class="next-steps winz">
          <h2>üìã WINZ Quote Generated!</h2>
          <ol class="steps-list">
            <li><span class="step-number">‚úì</span><span>Your quote has been generated and sent to your email</span></li>
            <li><span class="step-number">üì±</span><span>Check your phone for SMS confirmation</span></li>
            <li><span class="step-number">üè¢</span><span>Present quote at WINZ office or upload to MyMSD</span></li>
            <li><span class="step-number">‚è≥</span><span>WINZ processes within 1‚Äì2 business days</span></li>
            <li><span class="step-number">üîß</span><span>Once approved, call us to arrange service</span></li>
          </ol>
        </div>

        <div style="background: #fff3cd; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #ffc107; text-align: left;">
          <h4 style="color: #856404; margin: 0 0 15px 0;">üìã Important Information:</h4>
          <ul style="margin: 0; padding-left: 20px; color: #856404;">
            <li style="margin: 8px 0;">Your quote is valid for <strong>30 days</strong></li>
            <li style="margin: 8px 0;">WINZ can provide up to <strong>$400</strong> for urgent vehicle repairs</li>
            <li style="margin: 8px 0;">You don't need to be on a benefit to receive assistance</li>
            <li style="margin: 8px 0;">Keep your quote reference number for WINZ</li>
          </ul>
        </div>

        <div class="contact-info winz">
          <h3>üìû Need Help?</h3>
          <p>If you need assistance with the WINZ process or haven't received your quote</p>
          <div class="contact-buttons">
            <a href="tel:048873331" class="btn btn-winz phone-link" onclick="trackCall('winz_quote_help')">üìû Call Eek: 04 887 3331</a>
            <a href="tel:0800559009" class="btn btn-primary" onclick="trackCall('winz_help')">üìû Call WINZ: 0800 559 009</a>
          </div>
        </div>
      </div>

      <!-- Regular Payment Success Section -->
      <div id="paymentSection" style="display: none;">
        <div class="estimated-time">
          <h3>‚úÖ Service Confirmed</h3>
          <div class="time-display" id="timeDisplay">In Progress<div class="loading-animation"></div></div>
          <p id="serviceTypeText">Your service request is now active and being processed</p>
        </div>

        <div class="next-steps">
          <h2>üìã Service In Progress</h2>
          <ol class="steps-list">
            <li><span class="step-number">‚úì</span><span>Payment confirmed ‚Äî your service is now active</span></li>
            <li><span class="step-number">üìû</span><span>You'll receive a call/SMS update with technician details shortly</span></li>
            <li><span class="step-number">üîß</span><span>Service will be completed on-site with professional equipment</span></li>
            <li><span class="step-number">üìß</span><span>You'll receive a service completion report via email</span></li>
          </ol>
        </div>

        <div class="contact-info">
          <h3>üìû Need Immediate Assistance?</h3>
          <p>Our dispatch team is standing by if you need to update your location or have urgent questions</p>
          <div class="contact-buttons">
            <a href="tel:048873331" class="btn btn-primary phone-link" onclick="trackCall('thanks_page_call')">üìû Call 04 887 3331</a>
          </div>
        </div>
      </div>

      <div class="additional-services">
        <h3>üõ†Ô∏è Need Additional Services?</h3>
        <p>Access our complete range of services and support options</p>
        <div class="service-links">
          <a href="https://www.eek.nz/customer-escalation">üìù Customer Support</a>
          <a href="https://www.eek.nz/review-form">‚≠ê Leave a Review</a>
          <a href="https://www.eek.nz/insurance-form">üõ°Ô∏è Insurance Claims</a>
          <a href="https://www.eek.nz/more-options">üìã More Services</a>
          <a href="https://www.eek.nz/find-me">üìç Update Location</a>
          <a href="https://www.eek.nz/helper-form">üÜò Emergency Help</a>
        </div>
      </div>

      <div class="footer-links">
        <a href="https://www.eek.nz/">‚Üê Back to Home</a>
        <a href="https://www.eek.nz/terms">Terms of Service</a>
        <a href="https://www.eek.nz/privacy">Privacy Policy</a>
      </div>
    </div>
  </div>

  <script>
    // Phone Number Management
    function extractGCLID(urlParams) {
        const v = (urlParams.get('gclid') || urlParams.get('gbraid') || urlParams.get('wbraid'));
        return v && v.trim() ? v : null;
    }

    function getDisplayPhoneNumber() {
        const urlParams = new URLSearchParams(window.location.search);
        const g = extractGCLID(urlParams);
        if (g) return { tel: 'tel:0800600506', display: '0800 600 506' };
        return { tel: 'tel:048873331', display: '04 887 3331' };
    }

    function updatePhoneNumbers() {
        const phone = getDisplayPhoneNumber();
        document.querySelectorAll('.phone-link').forEach(el => {
            el.href = phone.tel;
            if (el.textContent.includes('Call')) {
                el.textContent = el.textContent.replace(/\d{3,4}\s?\d{3}\s?\d{3,4}/, phone.display);
            }
        });
    }

    // === INITIALIZATION ===
    console.log('üöÄ === THANKS PAGE INITIALIZED (Enhanced Data Retention) === üöÄ');

    // Power Automate URLs
    const PAYMENT_CONFIRMED_WEBHOOK_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c8ac1b8ac2574f66ad4efcdc23165379/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=kg6bffZKUQzUVR7jzpdTRaeudIa_T99V1hpzb_VlXPk';
    const SHAREPOINT_LOOKUP_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c35b9414a0be42f88182ae7e6e409f1d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2ztt24wScLuAfifD0pjzovseRDKXBAEtCQtScGMgPqQ';

    // Global store
    let bookingData = {};

    // === HELPERS ===
    function coalesce(...vals){ for (const v of vals){ if (v !== undefined && v !== null && v !== '') return v; } return undefined; }
    function sanitizePhone(v){ return (v||'').replace(/\D/g,''); }
    function cleanText(v){ return (v||'').toString().trim().replace(/\s+/g,' '); }

    // Canonicalizer
    function toCanonical(raw){
      const canonical = {};
      canonical.sessionId   = coalesce(raw.sessionId, raw.sid, `session_${Date.now()}`);
      
      // Set source based on GCLID availability
      const gclid = coalesce(raw.gclid, localStorage.getItem("eek_gclid"));
      canonical.source = gclid ? 'gclid' : 'organic';
      
      canonical.formVersion = coalesce(raw.formVersion, '2.0');

      canonical.name   = cleanText(coalesce(raw.name, raw.customerName));
      canonical.phone  = sanitizePhone(coalesce(raw.phone, raw.customerPhone));
      canonical.email  = cleanText(coalesce(raw.email, raw.customerEmail));
      canonical.location = cleanText(raw.location);

      canonical.rego   = cleanText(coalesce(raw.rego, raw.vehicleRego));
      canonical.year   = cleanText(coalesce(raw.year, raw.vehicleYear));
      canonical.make   = cleanText(coalesce(raw.make, raw.vehicleMake));
      canonical.model  = cleanText(coalesce(raw.model, raw.vehicleModel));
      canonical.vehicleType  = cleanText(raw.vehicleType);
      canonical.vehicleAddon = coalesce(raw.vehicleAddon, '');

      canonical.batteryVoltage = cleanText(coalesce(raw.batteryVoltage, raw.selectedVoltage));

      canonical.sellerName  = cleanText(raw.sellerName);
      canonical.sellerPhone = sanitizePhone(raw.sellerPhone);

      canonical.service      = cleanText(coalesce(raw.service, raw.serviceType));
      canonical.serviceCode  = cleanText(raw.serviceCode);
      canonical.serviceTitle = cleanText(coalesce(raw.serviceTitle, (raw.service === 'inspection' ? 'Pre Purchase Vehicle Inspection' : 'Mobile Mechanic Service')));

      canonical.scheduledDate   = cleanText(coalesce(raw.scheduledDate));
      canonical.scheduledDateNZ = cleanText(coalesce(raw.scheduledDateNZ));
      canonical.timeWindow      = cleanText(coalesce(raw.timeWindow, raw.selectedTime));
      canonical.urgencyLevel    = cleanText(coalesce(raw.urgencyLevel, raw.selectedUrgency));

      canonical.price   = String(coalesce(raw.price, raw.finalPrice, raw.calculatedPrice, ''));
      canonical.details = cleanText(coalesce(raw.details, raw.description));

      canonical.emergencyType  = cleanText(raw.emergencyType);
      canonical.quoteReference = cleanText(raw.quoteReference);
      canonical.isWinz         = coalesce(raw.isWinz, (raw.serviceCode === 'WINZ'), (raw.service || '').toLowerCase() === 'winz') ? 'true' : 'false';

      canonical.bookingTime    = coalesce(raw.bookingTime, new Date().toISOString());

      // Enhanced: Include Google tracking data
      canonical.gclid = coalesce(raw.gclid, localStorage.getItem("eek_gclid"));
      canonical.utm_source = coalesce(raw.utm_source, localStorage.getItem("eek_utm_source"));
      canonical.utm_medium = coalesce(raw.utm_medium, localStorage.getItem("eek_utm_medium"));
      canonical.utm_campaign = coalesce(raw.utm_campaign, localStorage.getItem("eek_utm_campaign"));
      canonical.utm_term = coalesce(raw.utm_term, localStorage.getItem("eek_utm_term"));
      canonical.utm_content = coalesce(raw.utm_content, localStorage.getItem("eek_utm_content"));

      canonical.sharepointId   = cleanText(raw.sharepointId);
      canonical._raw = raw;
      return canonical;
    }

    function isWinzQuote(data){
      return [
        (data.service || '').toLowerCase() === 'winz',
        (data.serviceCode || '').toUpperCase() === 'WINZ',
        !!data.emergencyType,
        !!(data.quoteReference && data.quoteReference.toUpperCase().includes('WINZ')),
        (data.serviceTitle || '').toLowerCase().includes('winz'),
        String(data.isWinz) === 'true'
      ].some(Boolean);
    }

    // === IDEMPOTENCY (Submit once) ===
    function idKeyFor(canon){
      return canon.sharepointId || canon.sessionId || (canon.quoteReference ? canon.quoteReference : (canon.phone ? `${canon.phone}_${canon.bookingTime}` : 'unknown'));
    }
    function postedKey(id){ return `eek_paid_posted:${id}`; }
    function hasAlreadyPosted(id){
      try{
        const raw = localStorage.getItem(postedKey(id));
        if(!raw) return false;
        const rec = JSON.parse(raw);
        return rec && rec.status === 'sent';
      }catch{ return true; }
    }
    function markPosted(id){
      try{ localStorage.setItem(postedKey(id), JSON.stringify({status:'sent', ts:new Date().toISOString()})); }catch{}
    }

    // === ENHANCED DATA RETRIEVAL ===
    async function fetchBookingDataFromSharePoint(bookingId){
      console.log('üîç Fetching booking from SharePoint‚Ä¶', bookingId);
      
      try{
        const res = await fetch(SHAREPOINT_LOOKUP_URL, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ bookingId })
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const result = await res.json();
        if(result.success && result.bookingData){
          const json = atob(result.bookingData);
          const decoded = JSON.parse(json);
          decoded.sharepointId = bookingId;
          decoded.sharepointStatus = result.status;
          decoded.retrievedAt = new Date().toISOString();
          console.log('‚úÖ SharePoint data retrieved successfully');
          return decoded;
        }
        console.log('‚ö†Ô∏è SharePoint returned success=false or no bookingData');
        return null;
      }catch(err){
        console.error('‚ùå SharePoint fetch error:', err);
        return null;
      }
    }

    // Enhanced data retrieval with multiple fallback sources
    function getComprehensiveBookingData(){
      console.log('üìä Building comprehensive booking data from all sources...');
      const data = {};
      
      // 1. URL Parameters (highest priority for explicit data)
      const params = new URLSearchParams(window.location.search);
      console.log('üîó URL parameters found:', params.toString());
      
      // Handle encoded data blob
      const encoded = params.get('d');
      if (encoded){
        try{ 
          const decoded = JSON.parse(atob(encoded));
          Object.assign(data, decoded);
          console.log('‚úÖ Decoded URL data blob');
        }catch(e){ 
          console.warn('‚ö†Ô∏è Legacy blob decode failed', e); 
        }
      }
      
      // Individual URL parameters
      for (const [k,v] of params){
        if (k !== 'd' && k !== 'bookingId'){ 
          data[k] = decodeURIComponent(v);
        }
      }
      
      // 2. Session Storage (booking form data)
      try{ 
        const ss = sessionStorage.getItem('eekBookingData'); 
        if (ss) {
          const sessionData = JSON.parse(ss);
          Object.assign(data, sessionData);
          console.log('‚úÖ Session storage data merged');
        }
      }catch(e){
        console.warn('‚ö†Ô∏è Session storage read failed', e);
      }
      
      // 3. Local Storage (persistent booking data)
      try{ 
        const ls = localStorage.getItem('eekBookingData'); 
        if (ls) {
          const localData = JSON.parse(ls);
          Object.assign(data, localData);
          console.log('‚úÖ Local storage data merged');
        }
      }catch(e){
        console.warn('‚ö†Ô∏è Local storage read failed', e);
      }
      
      // 4. Google Tracking Data (GCLID and attribution)
      const trackingData = getGoogleTrackingData();
      if (trackingData) {
        Object.assign(data, trackingData);
        console.log('‚úÖ Google tracking data merged');
      }
      
      // 5. Session ID continuity
      const sessionId = getSessionId();
      if (sessionId) {
        data.sessionId = sessionId;
        console.log('‚úÖ Session ID preserved:', sessionId);
      }
      
      console.log('üìã Final comprehensive data object:', data);
      return data;
    }

    // Get Google tracking data from localStorage
    function getGoogleTrackingData(){
      const trackingData = {};
      
      // GCLID with timestamp validation
      const gclid = localStorage.getItem("eek_gclid");
      const gclidTimestamp = localStorage.getItem("eek_gclid_timestamp");
      
      if (gclid && gclidTimestamp) {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        if (new Date(gclidTimestamp) > thirtyDaysAgo) {
          trackingData.gclid = gclid;
          trackingData.gclidTimestamp = gclidTimestamp;
          console.log('üìä Valid GCLID found:', gclid);
        } else {
          console.log('‚ö†Ô∏è GCLID expired, removing');
          localStorage.removeItem("eek_gclid");
          localStorage.removeItem("eek_gclid_timestamp");
        }
      }
      
      // UTM parameters
      ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
        const value = localStorage.getItem(`eek_${param}`);
        if (value) {
          trackingData[param] = value;
        }
      });
      
      // Last call attempt data for correlation
      const lastCallId = localStorage.getItem("eek_last_call_attempt_id");
      const lastCallTimestamp = localStorage.getItem("eek_last_call_timestamp");
      const lastCallGclid = localStorage.getItem("eek_last_gclid");
      
      if (lastCallId) {
        trackingData.lastCallAttemptId = lastCallId;
        trackingData.lastCallTimestamp = lastCallTimestamp;
        trackingData.lastCallGclid = lastCallGclid;
        console.log('üìû Call tracking data found');
      }
      
      return Object.keys(trackingData).length > 0 ? trackingData : null;
    }

    // Get session ID with fallback creation
    function getSessionId(){
      let sessionId = localStorage.getItem("eek_session_id");
      
      if (!sessionId) {
        // Try to get from URL parameters
        const params = new URLSearchParams(window.location.search);
        sessionId = params.get('session_id');
        
        if (sessionId) {
          localStorage.setItem("eek_session_id", sessionId);
          console.log('üîÑ Session ID restored from URL');
        } else {
          // Create new session ID as last resort
          sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          localStorage.setItem("eek_session_id", sessionId);
          console.log('üÜï New session ID created');
        }
      } else {
        console.log('‚úÖ Existing session ID found');
      }
      
      return sessionId;
    }

    // Get Google tracking data from localStorage
    function addDetailRow(buf, label, value){
      if (value !== undefined && value !== null && String(value).trim() !== ''){
        buf.push(`<div class="detail-row"><span class="detail-label">${label}:</span><span class="detail-value">${value}</span></div>`);
      }
    }

    function displayBookingDetails(data){
      const container = document.getElementById('bookingDetails');
      const content = document.getElementById('detailsContent');
      const rows = [];

      // Customer
      addDetailRow(rows, 'Name', data.name);
      addDetailRow(rows, 'Phone', data.phone);
      addDetailRow(rows, 'Email', data.email);

      // Service
      addDetailRow(rows, 'Service', data.serviceTitle || data.service);
      addDetailRow(rows, 'Service Code', data.serviceCode);
      addDetailRow(rows, 'Location', data.location);

      // Vehicle
      addDetailRow(rows, 'Registration', data.rego);
      const vehicleLine = [data.year, data.make, data.model].filter(Boolean).join(' ');
      addDetailRow(rows, 'Vehicle', vehicleLine);
      addDetailRow(rows, 'Battery Type', data.batteryVoltage);
      addDetailRow(rows, 'Vehicle Type', data.vehicleType);
      addDetailRow(rows, 'Vehicle Addon', data.vehicleAddon ? `$${data.vehicleAddon}` : '');

      // WINZ specifics
      if (isWinzQuote(data)){
        addDetailRow(rows, 'Emergency Type', data.emergencyType);
        addDetailRow(rows, 'Quote Reference', data.quoteReference);
        addDetailRow(rows, 'Quote Amount', data.price ? `$${data.price}` : '');
      }

      // Seller (inspection)
      addDetailRow(rows, 'Seller Name', data.sellerName);
      addDetailRow(rows, 'Seller Phone', data.sellerPhone);

      // Schedule
      addDetailRow(rows, 'Scheduled Date', data.scheduledDate);
      addDetailRow(rows, 'Time Window', data.timeWindow);
      addDetailRow(rows, 'Urgency Level', data.urgencyLevel);

      // Payment (non-WINZ)
      if (!isWinzQuote(data)){
        addDetailRow(rows, 'Amount Paid', data.price ? `$${data.price}` : '');
      }

      // Extra
      addDetailRow(rows, 'Details', data.details);
      addDetailRow(rows, 'Booking Time', data.bookingTime);

      // Enhanced: Google tracking data
      addDetailRow(rows, 'GCLID', data.gclid);
      addDetailRow(rows, 'UTM Source', data.utm_source);
      addDetailRow(rows, 'UTM Medium', data.utm_medium);
      addDetailRow(rows, 'UTM Campaign', data.utm_campaign);

      // Meta (Session ID only, no source/formVersion shown to customer)
      addDetailRow(rows, 'Session ID', data.sessionId);

      content.innerHTML = rows.join('');
      container.style.display = rows.length ? 'block' : 'none';
    }

    function displayContent(canon){
      const winz = isWinzQuote(canon);
      const successCard = document.getElementById('successCard');
      const successIcon = document.getElementById('successIcon');
      const mainTitle = document.getElementById('mainTitle');
      const mainSubtitle = document.getElementById('mainSubtitle');
      const winzSection = document.getElementById('winzSection');
      const paymentSection = document.getElementById('paymentSection');
      const bookingDetails = document.getElementById('bookingDetails');

      displayBookingDetails(canon);

      if (winz){
        successCard.classList.add('winz');
        successIcon.classList.add('winz');
        successIcon.textContent = 'üìã';
        mainTitle.classList.add('winz');
        mainTitle.textContent = 'WINZ Quote Generated!';
        mainSubtitle.textContent = 'Your quote has been sent to your email and phone';
        bookingDetails.classList.add('winz');
        winzSection.style.display = 'block';
        paymentSection.style.display = 'none';
        document.title = 'WINZ Quote Generated - Eek Mobile Mechanical';
      }else{
        winzSection.style.display = 'none';
        paymentSection.style.display = 'block';
        if (canon.serviceTitle){
          document.getElementById('serviceTypeText').textContent = `Your ${canon.serviceTitle} is now being processed`;
        }
      }
    }

    // === INTEGRATIONS ===
    async function sendToPaymentConfirmedFlow(canon){
      // Only for PAID (non-WINZ)
      if (isWinzQuote(canon)){
        console.log('üõë Skipping payment-confirmed webhook (WINZ quote).');
        return;
      }
      // Guardrails
      if (!canon.name || !canon.phone){
        console.log('üõë Missing name/phone ‚Äî not posting to payment-confirmed webhook.');
        return;
      }

      const id = idKeyFor(canon);
      const params = new URLSearchParams(window.location.search);
      const forceResend = params.get('resend') === '1';

      if (!forceResend && hasAlreadyPosted(id)){
        console.log(`üü® Duplicate detected for id=${id}. Skipping webhook post.`);
        // Show subtle indicator so support knows it was previously sent
        const indicator = document.getElementById('processingIndicator');
        indicator.style.display = 'block';
        indicator.textContent = '‚Ñπ Booking was already sent earlier (not re-posted)';
        setTimeout(()=> indicator.style.display='none', 5000);
        return;
      }

      const payload = {
        ...canon,
        idempotencyKey: id,                // helpful if the flow implements dedupe
        paymentConfirmedAt: new Date().toISOString(),
        paymentStatus: 'confirmed',
        pageLoadedAt: new Date().toISOString()
      };

      console.log('üì§ Posting to Payment Confirmed webhook:', payload);
      try{
        const res = await fetch(PAYMENT_CONFIRMED_WEBHOOK_URL, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if (res.ok){
          console.log('‚úÖ Payment confirmation sent.');
          markPosted(id);
          const indicator = document.getElementById('processingIndicator');
          indicator.style.display = 'block';
          indicator.textContent = '‚úÖ Booking data sent successfully';
          setTimeout(()=> indicator.style.display='none', 5000);
        }else{
          console.error('‚ùå Payment confirmation failed:', res.status, await res.text());
        }
      }catch(err){
        console.error('‚ùå Payment confirmation error:', err);
      }
    }

    function trackCall(source){
      if (typeof gtag !== 'undefined'){
        gtag('event','phone_call',{event_category:'Contact', event_label:source, value:1});
      }
      if (typeof rdt !== 'undefined'){
        rdt('track','Lead',{customEventName:'Post_Payment_Call', eventSource:source});
      }
    }

    function trackConversion(canon){
      const isWinz = isWinzQuote(canon);
      const price = parseFloat(canon.price) || 0;
      
      // Enhanced conversion tracking with GCLID
      const conversionData = {
        gclid: canon.gclid,
        session_id: canon.sessionId,
        utm_source: canon.utm_source,
        utm_medium: canon.utm_medium,
        utm_campaign: canon.utm_campaign
      };
      
      if (typeof gtag !== 'undefined'){
        if (isWinz){
          gtag('event','generate_lead',{
            currency:'NZD', 
            value: price || 299, 
            lead_source:'WINZ Quote', 
            service_type: canon.emergencyType || 'unknown',
            gclid: canon.gclid,
            session_id: canon.sessionId
          });
        }else if (price > 0){
          gtag('event','purchase',{
            transaction_id: canon.sessionId || String(Date.now()), 
            value: price, 
            currency:'NZD', 
            items:[{ 
              item_name: canon.serviceTitle || 'Mobile Mechanic Service', 
              price, 
              quantity:1, 
              item_category: canon.service || 'service' 
            }],
            gclid: canon.gclid,
            session_id: canon.sessionId
          });
        }
      }
      
      if (typeof rdt !== 'undefined'){
        if (isWinz){
          rdt('track','Lead',{
            customEventName:'WINZ_Quote_Generated', 
            currency:'NZD', 
            value: price || 299, 
            eventSource:'winz_quote_success',
            gclid: canon.gclid
          });
        }else if (price > 0){
          rdt('track','Purchase',{
            customEventName:'Payment_Completed', 
            currency:'NZD', 
            value: price, 
            eventSource:'thanks_page',
            gclid: canon.gclid
          });
        }
      }
    }

    // === BOOTSTRAP ===
    window.addEventListener('load', async () => {
      updatePhoneNumbers();
      const params = new URLSearchParams(window.location.search);
      const bookingId = params.get('bookingId');

      if (bookingId){
        const sp = await fetchBookingDataFromSharePoint(bookingId);
        bookingData = sp || getComprehensiveBookingData();
      }else{
        bookingData = getComprehensiveBookingData();
      }

      // Canonicalize once
      bookingData = toCanonical(bookingData);
      console.log('‚úÖ Canonical booking data:', bookingData);

      // Render
      displayContent(bookingData);

      // Integrations
      await sendToPaymentConfirmedFlow(bookingData);
      trackConversion(bookingData);

      // Store for quick debugging
      try { sessionStorage.setItem('lastThanksPageData', JSON.stringify(bookingData)); } catch {}
    });
  </script>
</body>
</html>
